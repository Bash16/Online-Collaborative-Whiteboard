<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Collaborative Whiteboard</title>
        <style>
            body {
                font-family: 'Arial', sans-serif;
                margin: 0;
                padding: 0;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                height: 100vh;
                background-color: #f5f5f5;
            }

            #whiteboard {
                border: 1px solid #000;
                margin-bottom: 20px;
            }

            #header {
                font-family: 'Pacifico', cursive;
                font-size: 36px;
                margin-bottom: 20px;
            }

            #controls {
                display: flex;
                flex-direction: row; /* Change to row */
                align-items: center;
                margin-bottom: 20px; /* Add margin to separate from the next section */
            }

            #colorPicker {
                margin-right: 20px;
            }

            #username {
                margin-left: 70px;
                margin-bottom: 10px;
                padding: 5px;
                font-size: 16px;
            }

            #setUsernameBtn {
                margin-left: 15px;
                padding: 8px;
                font-size: 16px;
                background-color: #4caf50;
                color: white;
                border: none;
                cursor: pointer;
            }

            #userList {
                margin-top: 20px;
                text-align: center;
            }

            .user {
                margin-bottom: 5px;
            }

            #clearCanvasBtn {
                padding: 8px;
                font-size: 16px;
                background-color: #f44336;
                color: white;
                border: none;
                cursor: pointer;
            }
        </style>
        <!-- Include jQuery -->
        <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/spectrum/1.8.1/spectrum.min.css" />
        <link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet">
    </head>
    <body>
        <div id="header">Collaborative Whiteboard</div>

        <canvas id="whiteboard" width="800" height="600"></canvas>

        <div id="controls">
            <!-- Add a color picker input -->
            <input type="text" id="colorPicker" value="#000000" />

            <!-- Add an input for setting the username -->
            <input type="text" id="username" placeholder="Enter your username" />

            <!-- Add a button to set the username -->
            <button id="setUsernameBtn">Set Username</button>
        </div>

        <button id="clearCanvasBtn" onclick="clearCanvas()">Clear Canvas</button>

        <!-- Add a div to display the list of connected users -->
        <div id="userList"></div>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>
        <!-- Include the Spectrum color picker library -->
        <script src="https://cdnjs.cloudflare.com/ajax/libs/spectrum/1.8.1/spectrum.min.js"></script>

        <script>
            const socket = io.connect('http://' + document.domain + ':' + location.port);
            const canvas = document.getElementById('whiteboard');
            const context = canvas.getContext('2d');
            let drawing = false;
            let selectedColor = '#000000'; // Initial color
            let username = null; // User's username
            let touchX, touchY;

            // Request initial drawing data when connecting to the server
            socket.on('connect', function () {
                socket.emit('get_initial_data');
            });

            // Initialize the Spectrum color picker
            $("#colorPicker").spectrum({
                preferredFormat: "hex",
                showPalette: true,
                palette: ["#000000", "#FF0000", "#00FF00", "#0000FF"], // Example colors
                change: function (color) {
                    selectedColor = color.toHexString();
                }
            });

            // Update the list of connected users
                socket.on('update_users', function(users) {
                    const userListDiv = document.getElementById('userList');
                    userListDiv.innerHTML = '<b>Users:</b><br>' + users.join('<br>');
                });


            // Add event listener for the "Set Username" button
            document.getElementById('setUsernameBtn').addEventListener('click', function () {
                setUsername();
            });

            function setUsername() {
                username = document.getElementById('username').value;

                console.log('Username set:', username);

                // Update the list of connected users immediately after setting the username
                updateUserList();

                // Emit 'set_username' event to inform the server
                socket.emit('set_username', username);
            }

            // For mouse/touchpad
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mousemove', draw);

            // For touch screens
            canvas.addEventListener('touchstart', startDrawing);
            canvas.addEventListener('touchmove', draw);
            canvas.addEventListener('touchend', stopDrawing);

            function startDrawing(e) {
                drawing = true;
                if (e.type === 'mousedown') {
                    startX = e.clientX - canvas.getBoundingClientRect().left;
                    startY = e.clientY - canvas.getBoundingClientRect().top;
                } else if (e.type === 'touchstart') {
                    const touch = e.touches[0];
                    startX = touch.clientX - canvas.getBoundingClientRect().left;
                    startY = touch.clientY - canvas.getBoundingClientRect().top;
                }
                draw(e);
            }

            function stopDrawing() {
                drawing = false;
                context.beginPath();
            }

            function draw(e) {
                if (!drawing || !username) return;

                const x = (e.clientX || e.touches[0].clientX) - canvas.getBoundingClientRect().left;
                const y = (e.clientY || e.touches[0].clientY) - canvas.getBoundingClientRect().top;

                context.lineJoin = 'round';
                context.lineCap = 'round';
                context.lineWidth = 5;
                context.strokeStyle = selectedColor;

                context.beginPath();
                context.moveTo(startX, startY);
                context.lineTo(x, y);
                context.stroke();
                context.closePath();

                startX = x;
                startY = y;

                const data = {
                    x: x / canvas.width,
                    y: y / canvas.height,
                    color: selectedColor,
                    username: username,
                };

                socket.emit('draw', data);
                updateUserList();
            }


            socket.on('draw', function (data) {
                const x = data.x * canvas.width;
                const y = data.y * canvas.height;

                context.lineJoin = 'round';
                context.lineCap = 'round';
                context.lineWidth = 5;
                context.strokeStyle = data.color; // Use the color received from other users

                context.beginPath(); // Start a new path for each point
                context.arc(x, y, 2.5, 0, 2 * Math.PI); // Draw a small circle (dot)
                context.fillStyle = data.color;
                context.fill();
                context.stroke();
            });

            function clearCanvas() {
                context.clearRect(0, 0, canvas.width, canvas.height);
                socket.emit('clear'); // Emit the 'clear' event
            }

            socket.on('clear', function () {
                context.clearRect(0, 0, canvas.width, canvas.height);
                updateUserList(); // Update the list of connected users
            });

            // Update the list of connected users
            function updateUserList() {
                socket.emit('get_user_list');
            }

            // Display the list of connected users
            socket.on('user_list', function (users) {
                const userListElement = document.getElementById('userList');
                userListElement.innerHTML = ''; // Clear the previous list

                users.forEach(user => {
                    const userElement = document.createElement('div');
                    userElement.className = 'user';
                    userElement.textContent = user;
                    userListElement.appendChild(userElement);
                });
            });
        </script>

    </body>
</html>

